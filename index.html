<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>VN Gold Charts with Indicators</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
  <script src="url.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: radial-gradient(circle at top, #373761, #121212);
      color: #e0e0e0;
    }

    h2 {
      margin: 15px 0 25px 0;
      text-align: center;
      font-size: 1.8rem;
      color: #ffffff;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .chart-box {
      background: linear-gradient(145deg, #1a1a1a, #575757);
      padding: 18px;
      border-radius: 16px;
      box-shadow: 8px 8px 16px #0e0e0e, -8px -8px 16px #2e2e2e;
    }

    .chart-box h3 {
      text-align: center;
      margin-bottom: 10px;
    }

    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .tab-btn {
      padding: 6px 12px;
      background: #333;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: #fff;
    }

    .tab-btn.active {
      background: #007bff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    canvas {
      background: #3c3c3c;
      border-radius: 12px;
      padding: 8px;
    }
  </style>
</head>

<body>
  <h2>VN Gold Charts with Indicators</h2>
  <div id="charts" class="charts-grid"></div>

  <script>
    // Utility functions (EMA, SMA, RSI, MACD...)
    function calcEMA(prices, period) {
      const k = 2 / (period + 1);
      let emaArray = [];
      let ema = prices[0];
      emaArray.push(ema);
      for (let i = 1; i < prices.length; i++) {
        ema = prices[i] * k + ema * (1 - k);
        emaArray.push(ema);
      }
      return emaArray;
    }
    function findCrosses(shortEma, longEma, labels) {
      let crosses = [];
      for (let i = 1; i < shortEma.length; i++) {
        if (shortEma[i - 1] < longEma[i - 1] && shortEma[i] >= longEma[i]) {
          crosses.push({ x: labels[i], y: shortEma[i], type: "golden" });
        }
        if (shortEma[i - 1] > longEma[i - 1] && shortEma[i] <= longEma[i]) {
          crosses.push({ x: labels[i], y: shortEma[i], type: "death" });
        }
      }
      return crosses;
    }
    function calcSMA(prices, period) {
      let sma = [];
      for (let i = 0; i < prices.length; i++) {
        if (i < period - 1) sma.push(null);
        else {
          let sum = 0;
          for (let j = 0; j < period; j++) sum += prices[i - j];
          sma.push(sum / period);
        }
      }
      return sma;
    }
    function calcStdDev(prices, period) {
      let stddev = [];
      for (let i = 0; i < prices.length; i++) {
        if (i < period - 1) stddev.push(null);
        else {
          let subset = prices.slice(i - period + 1, i + 1);
          let mean = subset.reduce((a, b) => a + b, 0) / period;
          let variance = subset.reduce((a, b) => a + (b - mean) ** 2, 0) / period;
          stddev.push(Math.sqrt(variance));
        }
      }
      return stddev;
    }
    function calcRSI(prices, period = 14) {
      let rsi = [];
      let gains = 0, losses = 0;
      for (let i = 1; i <= period; i++) {
        let change = prices[i] - prices[i - 1];
        if (change >= 0) gains += change; else losses -= change;
      }
      let avgGain = gains / period;
      let avgLoss = losses / period;
      rsi[period] = 100 - (100 / (1 + avgGain / avgLoss));
      for (let i = period + 1; i < prices.length; i++) {
        let change = prices[i] - prices[i - 1];
        if (change >= 0) {
          avgGain = (avgGain * (period - 1) + change) / period;
          avgLoss = (avgLoss * (period - 1)) / period;
        } else {
          avgGain = (avgGain * (period - 1)) / period;
          avgLoss = (avgLoss * (period - 1) - change) / period;
        }
        rsi[i] = 100 - (100 / (1 + avgGain / avgLoss));
      }
      return rsi;
    }
    function calcMACD(prices) {
      const ema12 = calcEMA(prices, 12);
      const ema26 = calcEMA(prices, 26);
      let macd = ema12.map((v, i) => v - ema26[i]);
      let signal = calcEMA(macd.filter(v => v !== undefined), 9);
      while (signal.length < macd.length) signal.unshift(null);
      return { macd, signal };
    }

    let charts = {}; // lÆ°u chart

    function createCharts(containerId, title, labels, prices) {
      const ema9 = calcEMA(prices, 9);
      const ema21 = calcEMA(prices, 21);
      const ema50 = calcEMA(prices, 50);
      const { macd, signal } = calcMACD(prices);
      const rsi = calcRSI(prices, 14);
      const sma20 = calcSMA(prices, 20);
      const std20 = calcStdDev(prices, 20);
      const upper = sma20.map((s, i) => (s && std20[i] ? s + 2 * std20[i] : null));
      const lower = sma20.map((s, i) => (s && std20[i] ? s - 2 * std20[i] : null));

      const chartBox = document.createElement("div");
      chartBox.className = "chart-box";
      chartBox.innerHTML = `<h3>${title}</h3>
        <div class="tabs">
          <button class="tab-btn active" data-tab="${title}-ema">EMA</button>
          <button class="tab-btn" data-tab="${title}-macd">MACD</button>
          <button class="tab-btn" data-tab="${title}-rsi">RSI</button>
          <button class="tab-btn" data-tab="${title}-bollinger">Bollinger</button>
        </div>
        <div id="${title}-ema" class="tab-content active"><canvas id="${title}-ema-canvas"></canvas></div>
        <div id="${title}-macd" class="tab-content"><canvas id="${title}-macd-canvas"></canvas></div>
        <div id="${title}-rsi" class="tab-content"><canvas id="${title}-rsi-canvas"></canvas></div>
        <div id="${title}-bollinger" class="tab-content"><canvas id="${title}-bollinger-canvas"></canvas></div>`;
      document.getElementById(containerId).appendChild(chartBox);

      const commonOptions = {
        plugins: {
          legend: {
            labels: {
              color: "#ffffff",
              boxWidth: 20,
              padding: 15,
              font: { size: 13 }
            }
          }
        },
        scales: {
          x: { ticks: { color: "#ccc" }, grid: { color: "rgba(128,128,128,0.3)" } },
          y: { ticks: { color: "#ccc" }, grid: { color: "rgba(128,128,128,0.3)" } }
        }
      };

      const crosses = findCrosses(ema9, ema21, labels);

      // EMA
      charts[`${title}-ema-canvas`] = new Chart(document.getElementById(`${title}-ema-canvas`), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Price", data: prices, borderColor: "white", pointRadius: 0 },
            { label: "EMA 9", data: ema9, borderColor: "red", pointRadius: 0 },
            { label: "EMA 21", data: ema21, borderColor: "yellow", pointRadius: 0 },
            { label: "EMA 50", data: ema50, borderColor: "green", pointRadius: 0 },
            { label: "Golden Cross", data: crosses.filter(c => c.type === "golden"), showLine: false, pointBackgroundColor: "cyan", pointRadius: 6 },
            { label: "Death Cross", data: crosses.filter(c => c.type === "death"), showLine: false, pointBackgroundColor: "black", pointRadius: 6 }
          ]
        },
        options: commonOptions
      });

      // MACD
      charts[`${title}-macd-canvas`] = new Chart(document.getElementById(`${title}-macd-canvas`), {
        type: "bar",
        data: {
          labels,
          datasets: [
            { type: "line", label: "MACD", data: macd, borderColor: "blue", borderWidth: 2, pointRadius: 0 },
            { type: "line", label: "Signal", data: signal, borderColor: "orange", borderWidth: 2, pointRadius: 0 },
            { type: "bar", label: "Histogram", data: macd.map((v, i) => v - signal[i]), backgroundColor: ctx => ctx.raw >= 0 ? "rgba(0,200,0,0.6)" : "rgba(200,0,0,0.6)" }
          ]
        },
        options: commonOptions
      });

      // RSI
      charts[`${title}-rsi-canvas`] = new Chart(document.getElementById(`${title}-rsi-canvas`), {
        type: "line",
        data: { labels, datasets: [{ label: "RSI", data: rsi, borderColor: "teal", pointRadius: 0 }] },
        options: {
          ...commonOptions,
          scales: { y: { min: 0, max: 100, ticks: { color: "#ccc" }, grid: { color: "rgba(128,128,128,0.3)" } } },
          plugins: {
            ...commonOptions.plugins,
            annotation: {
              annotations: {
                line30: { type: "line", yMin: 30, yMax: 30, borderColor: "yellow", borderDash: [6, 6] },
                line70: { type: "line", yMin: 70, yMax: 70, borderColor: "yellow", borderDash: [6, 6] }
              }
            }
          }
        }
      });

      // Bollinger
      charts[`${title}-bollinger-canvas`] = new Chart(document.getElementById(`${title}-bollinger-canvas`), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Price", data: prices, borderColor: "white", pointRadius: 0 },
            { label: "SMA 20", data: sma20, borderColor: "blue", pointRadius: 0 },
            { label: "Upper Band", data: upper, borderColor: "green", borderDash: [5, 5], pointRadius: 0 },
            { label: "Lower Band", data: lower, borderColor: "red", borderDash: [5, 5], pointRadius: 0 }
          ]
        },
        options: commonOptions
      });

      // Tab switching
      chartBox.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          chartBox.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
          chartBox.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
          btn.classList.add("active");
          const tabId = btn.dataset.tab;
          const tabContent = chartBox.querySelector("#" + tabId);
          tabContent.classList.add("active");
          const canvas = tabContent.querySelector("canvas");
          const chart = charts[canvas.id];
          if (chart) {
            chart.resize();
            chart.update();
          }
        });
      });
    }

    async function main() {
      const response = await fetch(url);
      const text = await response.text();
      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const labels = [];
          const sell = [];
          const world = [];
          results.data.forEach(row => {
            labels.push(row["Date"]);
            sell.push(parseFloat(row["Sell"]));
            world.push(parseFloat(row["World"]));
          });
          const container = document.getElementById("charts");
          const colSell = document.createElement("div");
          const colWorld = document.createElement("div");
          container.appendChild(colSell);
          container.appendChild(colWorld);
          createCharts(colSell.id = "colSell", "Vietnam", labels, sell);
          createCharts(colWorld.id = "colWorld", "World", labels, world);
        }
      });
    }
    main();
  </script>
</body>

</html>