<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>VN Gold Charts with Indicators</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
  <style>
    body {
      background: #0f172a;
      color: #e2e8f0;
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .card {
      background: #1e293b;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
    }

    .card-header {
      border-bottom: 1px solid #334155;
      margin-bottom: 10px;
    }

    .tabs {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .tab {
      cursor: pointer;
      padding: 6px 12px;
      font-size: 14px;
      color: #94a3b8;
    }

    .tab.active {
      background: #334155;
      border-radius: 6px;
      color: #f8fafc;
    }

    canvas {
      width: 100% !important;
      height: 400px !important;
    }
  </style>
</head>

<body>
  <h2>VN Gold Charts with Indicators</h2>
  <div class="grid">
    <!-- BUY CARD -->
    <div class="card">
      <div class="card-header">
        <ul class="tabs">
          <li class="tab active" data-target="buy-ema">EMA</li>
          <li class="tab" data-target="buy-macd">MACD</li>
          <li class="tab" data-target="buy-rsi">RSI</li>
          <li class="tab" data-target="buy-bollinger">Bollinger</li>
        </ul>
      </div>
      <div class="card-body">
        <canvas id="buy-ema"></canvas>
        <canvas id="buy-macd" style="display:none"></canvas>
        <canvas id="buy-rsi" style="display:none"></canvas>
        <canvas id="buy-bollinger" style="display:none"></canvas>
      </div>
    </div>

    <!-- SELL CARD -->
    <div class="card">
      <div class="card-header">
        <ul class="tabs">
          <li class="tab active" data-target="sell-ema">EMA</li>
          <li class="tab" data-target="sell-macd">MACD</li>
          <li class="tab" data-target="sell-rsi">RSI</li>
          <li class="tab" data-target="sell-bollinger">Bollinger</li>
        </ul>
      </div>
      <div class="card-body">
        <canvas id="sell-ema"></canvas>
        <canvas id="sell-macd" style="display:none"></canvas>
        <canvas id="sell-rsi" style="display:none"></canvas>
        <canvas id="sell-bollinger" style="display:none"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ===== Utility functions =====
    function calcEMA(prices, period) {
      const k = 2 / (period + 1);
      let emaArray = [];
      let ema = prices[0];
      emaArray.push(ema);
      for (let i = 1; i < prices.length; i++) {
        ema = prices[i] * k + ema * (1 - k);
        emaArray.push(ema);
      }
      return emaArray;
    }
    function calcSMA(prices, period) {
      let sma = [];
      for (let i = 0; i < prices.length; i++) {
        if (i < period - 1) sma.push(null);
        else {
          let sum = 0;
          for (let j = 0; j < period; j++) sum += prices[i - j];
          sma.push(sum / period);
        }
      }
      return sma;
    }
    function calcStdDev(prices, period) {
      let stddev = [];
      for (let i = 0; i < prices.length; i++) {
        if (i < period - 1) stddev.push(null);
        else {
          let subset = prices.slice(i - period + 1, i + 1);
          let mean = subset.reduce((a, b) => a + b, 0) / period;
          let variance = subset.reduce((a, b) => a + (b - mean) ** 2, 0) / period;
          stddev.push(Math.sqrt(variance));
        }
      }
      return stddev;
    }
    function calcRSI(prices, period = 14) {
      let rsi = [];
      let gains = 0, losses = 0;
      for (let i = 1; i <= period; i++) {
        let change = prices[i] - prices[i - 1];
        if (change >= 0) gains += change;
        else losses -= change;
      }
      let avgGain = gains / period;
      let avgLoss = losses / period;
      rsi[period] = 100 - (100 / (1 + avgGain / avgLoss));

      for (let i = period + 1; i < prices.length; i++) {
        let change = prices[i] - prices[i - 1];
        if (change >= 0) {
          avgGain = (avgGain * (period - 1) + change) / period;
          avgLoss = (avgLoss * (period - 1)) / period;
        } else {
          avgGain = (avgGain * (period - 1)) / period;
          avgLoss = (avgLoss * (period - 1) - change) / period;
        }
        rsi[i] = 100 - (100 / (1 + avgGain / avgLoss));
      }
      return rsi;
    }
    function calcMACD(prices) {
      const ema12 = calcEMA(prices, 12);
      const ema26 = calcEMA(prices, 26);
      let macd = ema12.map((v, i) => v - ema26[i]);
      let signal = calcEMA(macd.filter(v => v !== undefined), 9);
      while (signal.length < macd.length) signal.unshift(null);
      return { macd, signal };
    }

    // ===== Dark Mode Options =====
    const darkOptions = {
      plugins: {
        legend: {
          labels: {
            color: "#ddd",
            boxWidth: 12,
            font: { size: 10 }
          },
          align: "end"
        }
      },
      scales: {
        x: { ticks: { color: "#aaa" }, grid: { color: "#333" } },
        y: { ticks: { color: "#aaa" }, grid: { color: "#333" } }
      },
      elements: { line: { tension: 0.3, borderWidth: 2 } }
    };

    // ===== Tab Switch =====
    document.querySelectorAll(".tabs .tab").forEach(tab => {
      tab.addEventListener("click", () => {
        const parent = tab.closest(".card");
        parent.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        parent.querySelectorAll("canvas").forEach(c => c.style.display = "none");
        parent.querySelector("#" + tab.dataset.target).style.display = "block";
      });
    });

    // ===== Build charts =====
    function buildCharts(prefix, labels, prices) {
      const ema9 = calcEMA(prices, 9);
      const ema21 = calcEMA(prices, 21);
      const ema50 = calcEMA(prices, 50);
      const { macd, signal } = calcMACD(prices);
      const rsi = calcRSI(prices, 14);
      const sma20 = calcSMA(prices, 20);
      const std20 = calcStdDev(prices, 20);
      const bollUpper = sma20.map((s, i) => (s && std20[i] ? s + 2 * std20[i] : null));
      const bollLower = sma20.map((s, i) => (s && std20[i] ? s - 2 * std20[i] : null));

      // EMA
      new Chart(document.getElementById(`${prefix}-ema`), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Price", data: prices, borderColor: "white", fill: false },
            { label: "EMA 9", data: ema9, borderColor: "yellow", fill: false },
            { label: "EMA 21", data: ema21, borderColor: "cyan", fill: false },
            { label: "EMA 50", data: ema50, borderColor: "orange", fill: false }
          ]
        },
        options: darkOptions
      });

      // MACD
      new Chart(document.getElementById(`${prefix}-macd`), {
        data: {
          labels,
          datasets: [
            { type: "line", label: "MACD", data: macd, borderColor: "purple", fill: false },
            { type: "line", label: "Signal", data: signal, borderColor: "orange", fill: false },
            {
              type: "bar", label: "Histogram", data: macd.map((v, i) => v - signal[i]),
              backgroundColor: ctx => ctx.raw > 0 ? "rgba(0,255,0,0.5)" : "rgba(255,0,0,0.5)"
            }
          ]
        },
        options: { ...darkOptions }
      });

      // RSI
      new Chart(document.getElementById(`${prefix}-rsi`), {
        type: "line",
        data: { labels, datasets: [{ label: "RSI", data: rsi, borderColor: "lime", fill: false }] },
        options: {
          ...darkOptions,
          plugins: {
            annotation: {
              annotations: {
                line30: { type: "line", yMin: 30, yMax: 30, borderColor: "red", borderWidth: 1 },
                line70: { type: "line", yMin: 70, yMax: 70, borderColor: "red", borderWidth: 1 }
              }
            }
          }
        }
      });

      // Bollinger
      new Chart(document.getElementById(`${prefix}-bollinger`), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Price", data: prices, borderColor: "white", fill: false },
            { label: "Upper", data: bollUpper, borderColor: "red", fill: false },
            { label: "Lower", data: bollLower, borderColor: "red", fill: false }
          ]
        },
        options: darkOptions
      });
    }

    // ==== Main ====
    async function main() {
      const response = await fetch(url);
      const text = await response.text();
      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const labels = [];
          const buy = [];
          const sell = [];
          results.data.forEach(row => {
            labels.push(row["Date"]);
            buy.push(parseFloat(row["Buy"]));
            sell.push(parseFloat(row["Sell"]));
          });
          createCharts("charts", "Buy", labels, buy);
          createCharts("charts", "Sell", labels, sell);
        }
      });
    }

    main();
  </script>
</body>

</html>