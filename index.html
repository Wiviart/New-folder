<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Buy & Sell Charts with Indicators</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
  <script src="url.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f4f4f4;
    }

    h2 {
      margin: 15px 0;
    }

    .chart-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    @media (min-width: 900px) {
      .chart-container {
        grid-template-columns: 1fr 1fr;
      }
    }

    .chart-box {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <h2>VN Gold Charts with Indicators</h2>

  <div class="chart-container" id="charts"></div>

  <script>
    // ==== Utility functions ====
    function calcEMA(prices, period) {
      const k = 2 / (period + 1);
      let emaArray = [];
      let ema = prices[0];
      emaArray.push(ema);
      for (let i = 1; i < prices.length; i++) {
        ema = prices[i] * k + ema * (1 - k);
        emaArray.push(ema);
      }
      return emaArray;
    }

    function calcSMA(prices, period) {
      let sma = [];
      for (let i = 0; i < prices.length; i++) {
        if (i < period - 1) {
          sma.push(null);
        } else {
          let sum = 0;
          for (let j = 0; j < period; j++) sum += prices[i - j];
          sma.push(sum / period);
        }
      }
      return sma;
    }

    function calcStdDev(prices, period) {
      let stddev = [];
      for (let i = 0; i < prices.length; i++) {
        if (i < period - 1) {
          stddev.push(null);
        } else {
          let subset = prices.slice(i - period + 1, i + 1);
          let mean = subset.reduce((a, b) => a + b, 0) / period;
          let variance = subset.reduce((a, b) => a + (b - mean) ** 2, 0) / period;
          stddev.push(Math.sqrt(variance));
        }
      }
      return stddev;
    }

    function calcRSI(prices, period = 14) {
      let rsi = [];
      let gains = 0, losses = 0;
      for (let i = 1; i <= period; i++) {
        let change = prices[i] - prices[i - 1];
        if (change >= 0) gains += change;
        else losses -= change;
      }
      let avgGain = gains / period;
      let avgLoss = losses / period;
      rsi[period] = 100 - (100 / (1 + avgGain / avgLoss));

      for (let i = period + 1; i < prices.length; i++) {
        let change = prices[i] - prices[i - 1];
        if (change >= 0) {
          avgGain = (avgGain * (period - 1) + change) / period;
          avgLoss = (avgLoss * (period - 1)) / period;
        } else {
          avgGain = (avgGain * (period - 1)) / period;
          avgLoss = (avgLoss * (period - 1) - change) / period;
        }
        rsi[i] = 100 - (100 / (1 + avgGain / avgLoss));
      }
      return rsi;
    }

    function calcMACD(prices) {
      const ema12 = calcEMA(prices, 12);
      const ema26 = calcEMA(prices, 26);
      let macd = ema12.map((v, i) => v - ema26[i]);
      let signal = calcEMA(macd.filter(v => v !== undefined), 9);
      // align length
      while (signal.length < macd.length) signal.unshift(null);
      return { macd, signal };
    }

    // ==== Chart Creation ====
    function createCharts(containerId, title, labels, prices) {
      const ema9 = calcEMA(prices, 9);
      const ema21 = calcEMA(prices, 21);
      const ema50 = calcEMA(prices, 50);
      const { macd, signal } = calcMACD(prices);
      const rsi = calcRSI(prices, 14);
      const sma20 = calcSMA(prices, 20);
      const std20 = calcStdDev(prices, 20);
      const upper = sma20.map((s, i) => (s && std20[i] ? s + 2 * std20[i] : null));
      const lower = sma20.map((s, i) => (s && std20[i] ? s - 2 * std20[i] : null));

      const chartBox = document.createElement("div");
      chartBox.className = "chart-box";
      chartBox.innerHTML = `<h3>${title}</h3>
        <canvas id="${title}-ema"></canvas>
        <canvas id="${title}-macd"></canvas>
        <canvas id="${title}-rsi"></canvas>
        <canvas id="${title}-bollinger"></canvas>`;
      document.getElementById(containerId).appendChild(chartBox);

      // EMA
      new Chart(document.getElementById(`${title}-ema`), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Price", data: prices, borderColor: "black", fill: false },
            { label: "EMA 9", data: ema9, borderColor: "red", fill: false },
            { label: "EMA 21", data: ema21, borderColor: "blue", fill: false },
            { label: "EMA 50", data: ema50, borderColor: "green", fill: false }
          ]
        }
      });

      // MACD
      new Chart(document.getElementById(`${title}-macd`), {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              type: "line",
              label: "MACD",
              data: macd,
              borderColor: "purple",
              borderWidth: 2,
              fill: false,
              yAxisID: "y",
            },
            {
              type: "line",
              label: "Signal",
              data: signal,
              borderColor: "orange",
              borderWidth: 2,
              fill: false,
              yAxisID: "y",
            },
            {
              type: "bar",
              label: "Histogram",
              data: macd.map((v, i) => v - signal[i]),
              backgroundColor: function (ctx) {
                let value = ctx.raw;
                return value >= 0 ? "rgba(0,200,0,0.6)" : "rgba(200,0,0,0.6)";
              },
              yAxisID: "y",
            }
          ]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // RSI
      new Chart(document.getElementById(`${title}-rsi`), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "RSI", data: rsi, borderColor: "teal", fill: false }
          ]
        },
        options: {
          scales: {
            y: { min: 0, max: 100 }
          },
          plugins: {
            annotation: {
              annotations: {
                line30: {
                  type: "line",
                  yMin: 30,
                  yMax: 30,
                  borderColor: "red",
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    content: "30%",
                    enabled: true,
                    position: "start",
                    color: "red"
                  }
                },
                line70: {
                  type: "line",
                  yMin: 70,
                  yMax: 70,
                  borderColor: "red",
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    content: "70%",
                    enabled: true,
                    position: "start",
                    color: "red"
                  }
                }
              }
            }
          }
        }
      });


      // Bollinger
      new Chart(document.getElementById(`${title}-bollinger`), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Price", data: prices, borderColor: "black", fill: false },
            { label: "SMA 20", data: sma20, borderColor: "blue", fill: false },
            { label: "Upper Band", data: upper, borderColor: "green", borderDash: [5, 5], fill: false },
            { label: "Lower Band", data: lower, borderColor: "red", borderDash: [5, 5], fill: false }
          ]
        }
      });
    }

    // ==== Main ====
    async function main() {
      const response = await fetch(url);
      const text = await response.text();
      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const labels = [];
          const buy = [];
          const sell = [];
          results.data.forEach(row => {
            labels.push(row["Date"]);
            buy.push(parseFloat(row["Buy"]));
            sell.push(parseFloat(row["Sell"]));
          });
          createCharts("charts", "Buy", labels, buy);
          createCharts("charts", "Sell", labels, sell);
        }
      });
    }

    main();
  </script>
</body>

</html>