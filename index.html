<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>VN Gold Chart with Indicators</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f4f4f4;
    }

    .chart-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    @media (min-width: 900px) {
      .chart-container {
        grid-template-columns: 1fr 1fr;
      }
    }

    .chart-box {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <h2>VN Gold Chart with Indicators</h2>
  <div class="chart-container">
    <div class="chart-box"><canvas id="emaChart"></canvas></div>
    <div class="chart-box"><canvas id="macdChart"></canvas></div>
    <div class="chart-box"><canvas id="rsiChart"></canvas></div>
    <div class="chart-box"><canvas id="volumeChart"></canvas></div>
  </div>

  <script>
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQTQ1yBIEkZ8mzenOYDP5PyiKiF4T8Z0kLrNKi7Bazto_iGEAlJNScc6WU_Yzv8EGG8F8zBvgNu-659/pub?gid=0&single=true&output=csv";

    // Hàm tính EMA
    function calcEMA(prices, period) {
      let k = 2 / (period + 1);
      let emaArray = [];
      let ema = prices[0];
      emaArray.push(ema);
      for (let i = 1; i < prices.length; i++) {
        ema = prices[i] * k + ema * (1 - k);
        emaArray.push(ema);
      }
      return emaArray;
    }

    async function fetchSheetData() {
      const response = await fetch(url);
      const text = await response.text();

      return new Promise((resolve) => {
        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            const labels = [];
            const buy = [];
            const sell = [];
            const volumes = [];

            results.data.forEach(row => {
              labels.push(row["Date"]);
              buy.push(parseFloat(row["Buy"].replace(/,/g, "")));
              sell.push(parseFloat(row["Sell"].replace(/,/g, "")));
              volumes.push(parseFloat(row["Volume"] || 0)); // nếu có cột Volume
            });

            resolve({ labels, buy, sell, volumes });
          }
        });
      });
    }

    // Khởi tạo chart sau khi có dữ liệu
    fetchSheetData().then(({ labels, buy, sell, volumes }) => {
      const prices = buy; // hoặc sell, tùy bạn muốn phân tích theo giá nào

      // EMA
      const ema9 = calcEMA(prices, 9);
      const ema21 = calcEMA(prices, 21);
      const ema50 = calcEMA(prices, 50);

      new Chart(document.getElementById("emaChart"), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Price", data: prices, borderColor: "black", fill: false },
            { label: "EMA 9", data: ema9, borderColor: "red", fill: false },
            { label: "EMA 21", data: ema21, borderColor: "blue", fill: false },
            { label: "EMA 50", data: ema50, borderColor: "green", fill: false }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: "bottom" } } }
      });

      // MACD (demo)
      new Chart(document.getElementById("macdChart"), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "MACD", data: [0.1, 0.2, 0.15, 0.25, 0.3, 0.2, 0.35, 0.4], borderColor: "purple", fill: false },
            { label: "Signal", data: [0.05, 0.1, 0.12, 0.15, 0.2, 0.18, 0.25, 0.3], borderColor: "orange", fill: false }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: "bottom" } } }
      });

      // RSI (demo)
      new Chart(document.getElementById("rsiChart"), {
        type: "line",
        data: {
          labels,
          datasets: [{ label: "RSI", data: [40, 45, 50, 55, 60, 65, 70, 68], borderColor: "teal", fill: false }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } },
          scales: { y: { min: 0, max: 100 } }
        }
      });

      // Volume
      new Chart(document.getElementById("volumeChart"), {
        type: "bar",
        data: { labels, datasets: [{ label: "Volume", data: volumes, backgroundColor: "gray" }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    });
  </script>
</body>

</html>